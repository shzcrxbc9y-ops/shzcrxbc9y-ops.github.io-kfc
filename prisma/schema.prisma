// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// PostgreSQL поддерживает все функции

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  password          String
  firstName         String
  lastName          String
  role              String    @default("EMPLOYEE") // ADMIN, MENTOR, EMPLOYEE
  position          String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Связи
  progress          Progress?
  testResults       TestResult[]
  certifications    Certification[]
  achievements      UserAchievement[]
  
  @@map("users")
}

model Section {
  id                String    @id @default(cuid())
  title             String
  description       String?
  order             Int       @default(0)
  stationId         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Связи
  station           Station?  @relation(fields: [stationId], references: [id])
  materials         Material[]
  tests             Test[]
  
  @@map("sections")
}

model Station {
  id                String    @id @default(cuid())
  name              String
  description       String?
  order             Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Связи
  sections          Section[]
  certifications    Certification[]
  
  @@map("stations")
}

model Material {
  id                String    @id @default(cuid())
  sectionId         String
  title             String
  content           String    // HTML контент
  type              String    @default("text") // text, video, image, audio, pdf, file
  videoUrl          String?
  imageUrl          String?
  audioUrl          String?
  fileUrl           String?   // Для PDF и других файлов
  fileName          String?  // Оригинальное имя файла
  fileSize          Int?     // Размер файла в байтах
  order             Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Связи
  section           Section   @relation(fields: [sectionId], references: [id])
  
  @@map("materials")
}

model Test {
  id                String    @id @default(cuid())
  sectionId         String
  title             String
  description       String?
  passingScore      Int       @default(70) // Процент для прохождения
  timeLimit         Int?      // Лимит времени в минутах
  isCertification   Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Связи
  section           Section   @relation(fields: [sectionId], references: [id])
  questions         Question[]
  results           TestResult[]
  
  @@map("tests")
}

model Question {
  id                String    @id @default(cuid())
  testId            String
  text              String
  type              String    @default("single") // single, multiple
  order             Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Связи
  test              Test      @relation(fields: [testId], references: [id])
  options           Option[]
  
  @@map("questions")
}

model Option {
  id                String    @id @default(cuid())
  questionId        String
  text              String
  isCorrect         Boolean   @default(false)
  order             Int       @default(0)
  createdAt         DateTime  @default(now())
  
  // Связи
  question          Question  @relation(fields: [questionId], references: [id])
  
  @@map("options")
}

model TestResult {
  id                String    @id @default(cuid())
  userId            String
  testId            String
  score             Int       // Процент правильных ответов
  status            String    @default("NOT_STARTED") // NOT_STARTED, IN_PROGRESS, COMPLETED, PASSED, FAILED
  startedAt         DateTime?
  completedAt       DateTime?
  timeSpent         Int?      // Время в секундах
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Связи
  user              User      @relation(fields: [userId], references: [id])
  test              Test      @relation(fields: [testId], references: [id])
  answers           Answer[]
  
  @@map("test_results")
}

model Answer {
  id                String    @id @default(cuid())
  testResultId     String
  questionId        String
  optionIds         String    // JSON массив ID выбранных опций
  isCorrect         Boolean
  createdAt         DateTime  @default(now())
  
  // Связи
  testResult        TestResult @relation(fields: [testResultId], references: [id])
  
  @@map("answers")
}

model Certification {
  id                String    @id @default(cuid())
  userId            String
  stationId         String
  status            String    @default("NOT_STARTED") // NOT_STARTED, IN_PROGRESS, PASSED, FAILED
  score             Int?
  completedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Связи
  user              User      @relation(fields: [userId], references: [id])
  station           Station   @relation(fields: [stationId], references: [id])
  
  @@unique([userId, stationId])
  @@map("certifications")
}

model Progress {
  id                String    @id @default(cuid())
  userId            String    @unique
  sectionsCompleted Int       @default(0)
  testsCompleted    Int       @default(0)
  certificationsPassed Int    @default(0)
  totalScore        Int       @default(0)
  level             Int       @default(1)
  experience        Int       @default(0)
  updatedAt         DateTime  @updatedAt
  
  // Связи
  user              User      @relation(fields: [userId], references: [id])
  
  @@map("progress")
}

model Achievement {
  id                String    @id @default(cuid())
  title             String
  description       String
  icon              String?
  condition         String    // JSON условие для получения
  createdAt         DateTime  @default(now())
  
  // Связи
  userAchievements  UserAchievement[]
  
  @@map("achievements")
}

model UserAchievement {
  id                String    @id @default(cuid())
  userId            String
  achievementId     String
  unlockedAt        DateTime  @default(now())
  
  // Связи
  user              User      @relation(fields: [userId], references: [id])
  achievement       Achievement @relation(fields: [achievementId], references: [id])
  
  @@unique([userId, achievementId])
  @@map("user_achievements")
}

